<!doctype html>
<html>
    <head>
      <meta charset="UTF-8" />
      <title>Hero Quest!</title>
      <!-- Javascript Vendor Loading -->
      <script src="javascript/vendor/lodash.js"></script>
      <script src="javascript/vendor/zepto.js"></script>
      <script src="javascript/vendor/rsvp.js"></script>
      <script src="javascript/vendor/phaser.min.js"></script>

      <!-- Javascript Library Loading -->
      <script src="javascript/lib/lodash_extension.js"></script>
      <script src="javascript/lib/ajax_promise.js"></script>

      <!-- Javascript Model Loading -->
      <script src="javascript/models/controlable.js"></script>
      <script src="javascript/models/grid_movement.js"></script>
      <script src="javascript/models/app_model.js"></script>
      <script src="javascript/models/session.js"></script>
      <script src="javascript/models/facade/server.js"></script>

      <!-- Javascript ViewModel Loading -->
      <script src="javascript/viewmodels/game_hud.js"></script>

      <!-- Stylesheet Loading -->
      <link href="stylesheets/index.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>
    <script type="text/javascript">
    // Initial State
    window.state = {
      "hero_id": "",
      "email": "",
      "slot": null,
      "toggle_join_flow": false,
      "session_data": {},
      "session_id": "-KRPy5LjB77066DYy99M",
      "server_url": "http://localhost:3000",
      "toggle_slot_1": false,
      "toggle_slot_2": false,
      "game_state": "connecting",
      "game_started": false,
      "turn": "",
      "player_acting": false
    }

    // Instantiate Request Obj
    window.server = new Server(state.server_url,  {
      success: function(result) {
        if(result.action == undefined) {
          throw result.error;
        } else {
          action_methods[result.action.name](result.action);
        }
      },
      error: function(action) {
        if(action.error) {
          console.log(action.error);
        } else {
          console.log(action);
        }
      }
    });

    // Dispatchers
    window.dispatchers = {
      "toggle_join_flow" : function(bool) {
        state.toggle_join_flow = bool;
      },
      "set_session_id" : function(session_id) {
        state.session_id = session_id
      },
      "update_session_data" : function(data) {
        state.session_data = data;
      },
      "toggle_slot_1" : function(bool) {
        state.toggle_slot_1 = bool;
      },
      "toggle_slot_2" : function(bool) {
        state.toggle_slot_2 = bool;
      },
      "set_email": function(email) {
        state.email = email;
      },
      "start_game": function() {
        if(state.game_state == "connecting") {
          state.game_state = "playing"
        }
      },
      "started_game": function() {
        state.game_started = true;
      },
      "set_hero_id": function(id) {
        state.hero_id = id;
      },
      "set_slot": function(slot) {
        state.slot = slot;
      },
      "set_turn": function(id) {
        state.turn = id;
      },
      "set_player_acting": function(bool) {
        state.player_acting = bool;
      }
    }

    window.action_methods = {
      "account_joined" : function(action) {
        console.log(`ActionMethod: Adicionar email -> ${window.state.email}`);
        dispatchers.toggle_join_flow(true);

        var index = _.findIndex(_.values(action.data._setup.heroes), function(hero) {
          return hero.account.email == state.email
        });
        dispatchers.set_slot(index);

        update_session(action.data);

        var hero_id = _.keys(state.session_data._setup.heroes)[index];
        dispatchers.set_hero_id(hero_id);
      },
      "waiting_quorum" : function(action) {
        console.log("ActionMethod: Esperando Quorum");
      },
      "update_session" : function(action) {
        console.log("ActionMethod: Atualizar Session");
        update_session(action.data);
      },
      "active_turn" : function(action) {
        console.log("ActionMethod: Atualizar Turn");
        dispatchers.set_turn(action.data.hero_id);
      },
      "action_saved" : function(action) {
        console.log("ActionMethod: Atualizar Session");
      }
    }

    function update_session(session) {
      dispatchers.update_session_data(session);

      var heroes = _.try(session, "_setup.heroes");
      var s1 = _.keys(heroes)[0];
      var s2 = _.keys(heroes)[1];
      dispatchers.toggle_slot_1(false);
      dispatchers.toggle_slot_2(false);

      if(s1 != undefined) {
        dispatchers.toggle_slot_1(true);
      }
      if(s2 != undefined) {
        dispatchers.toggle_slot_2(true);
      }

      if(s1 && s2) {
        dispatchers.start_game();
      }
    }

    window.game_hud = new GameHud();

    // Phaser Engine
    function start_game() {
      window.game = new Phaser.Game(320, 320, Phaser.AUTO, '', { preload: preload, create: create, update: update });
      // console.log("Instancia do jogo criada..", game);
      window.controlable = new Controllable(game);
      window.grid = new GridMovement("32x32", "10x10");
    }

    function preload () {
        game.load.tilemap('map', 'images/tileset.csv', null, Phaser.Tilemap.CSV);
        game.load.image('tiles', 'images/base_tileset.png');
        game.load.spritesheet('hero', 'images/charset.png', 32, 32);
    }

    function create () {
        // Rendering Tilemaps and World
        this.map = this.add.tilemap('map', 32, 32);
        this.map.addTilesetImage('tiles');
        this.layer = this.map.createLayer(0);
        this.layer.resizeWorld();

        // Rendering Slot 1
        window.p1 = this.add.tileSprite(0, 0, 32, 32, 'hero');
        p1.animations.add('iddle', [0], 10, true);
        p1.animations.play('iddle');

        // Rendering Slot 2
        window.p2 = this.add.tileSprite(0, 0, 32, 32, 'hero');
        p2.animations.add('iddle', [5], 10, true);
        p2.animations.play('iddle');

        console.log(state);

        // Setup slots initial position
        grid.move(p1, 1,1);
        grid.move(p2, 1,2);

        console.log("Jogo perfeitamente criado!");

        // Delegate which Slot the player controls
        controlable.delegate(p1);
    }

    function update() {
      if(window.state.slot != null) {
        controlable.control(function() {
          dispatchers.set_player_acting(true);
        });

        if(window.state.slot == 0) {
          controlable.delegate(window.p1);
        } else {
          controlable.delegate(window.p2);
        }
      }
    }

    window.game = null;
    window.onload = function() {
    };

    $(document).ready(function() {
      setInterval(function() {
        server.update_session(state.session_id);
        game_hud.update_player_board(state);

        if(state.game_state == "playing" && !state.game_started) {
          dispatchers.started_game();
          start_game();
        }

        if (state.game_started) {
          server.set_turn(state.session_id);
          game_hud.update_turn_modal(state);

          if(state.player_acting) {
            dispatchers.set_player_acting(false);
            server.action(state.session_id, 'move', state.turn, {
              position: "2,2"
            })
          }
        }
      }, 1000);


      $(".join-game").bind("click", function() {
        dispatchers.set_session_id($(".session-id").val());
        var email = prompt("What is your email?");
        dispatchers.set_email(email);
        server.join_game(state.session_id, {
          email: email
        });
      });

      $(".take-slot").bind("click", function() {
        var slot = parseInt(prompt("Qual Slot?"));
        var email = _.objByKey(state.session_data._setup.heroes, slot).account.email;
        var hero_id = _.keys(state.session_data._setup.heroes)[slot];

        dispatchers.set_hero_id(hero_id);
        dispatchers.set_email(email);
        dispatchers.set_slot(slot);
      });
    });

    </script>

    <section class="player-status">
      <h1>Jogadores conectados</h1>
      <input type="text" class="session-id" value="-KRPy5LjB77066DYy99M"></input>
      <button class="join-game">Entrar no Jogo</button>
      <button class="take-slot">Assumir Slot</button>
      <div class="player-slot player-slot-1">
        <h2>Slot 1</h2>
        <p class="player-email"></p>
      </div>
      <div class="player-slot player-slot-2">
        <h2>Slot 2</h2>
        <p class="player-email"></p>
      </div>
    </section>

    <section class="modal_turn">
      <h2 class="not_now">Não é sua vez agora!</h2>
    </section>

    </body>
</html>
